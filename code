// === MOISTURE SENSOR CALIBRATION ===
// This program prints raw sensor values (0â€“1023)
// so you can find the DRY and WET calibration points.

const int PIN_SOIL = A0;  // Sensor signal pin

void setup() {
  Serial.begin(9600);
  pinMode(PIN_SOIL, INPUT);

  Serial.println("=== MOISTURE SENSOR CALIBRATION ===");
  Serial.println("1) Keep the sensor in AIR (DRY) â†’ record the value");
  Serial.println("2) Put the sensor in WATER or WET SOIL â†’ record the value");
  Serial.println("--------------------------------------");
}

void loop() {
  int raw = analogRead(PIN_SOIL);

  Serial.print("Raw value: ");
  Serial.println(raw);

  delay(500);  // Update twice per second
}




// Main code
#include <Wire.h> 
#include <LiquidCrystal_I2C.h>

// ================= SETTINGS (FOR YOUR SENSOR) =================
const int PIN_SOIL = A0;   // Your moisture sensor is connected here
const int PIN_PUMP = 9;    // PWM wire from MOSFET goes here

// Calibration: These numbers depend on your specific sensor!
// If readings look incorrect, swap the values or adjust them.
const int VAL_AIR   = 970; // Sensor reading when completely dry (in air)
const int VAL_WATER = 570; // Sensor reading when in water

// Pump control thresholds (in percent)
const int START_LEVEL = 30; // If below 30% -> TURN PUMP ON
const int STOP_LEVEL  = 70; // If above 70% -> TURN PUMP OFF
// ==============================================================

bool isPumping = false; // Variable to store pump state

// LCD settings (address usually 0x27, if it doesn't work try 0x3F)
LiquidCrystal_I2C lcd(0x27, 16, 2); 

void setup() {
  // Configure pins
  pinMode(PIN_PUMP, OUTPUT);
  pinMode(PIN_SOIL, INPUT);

  // Initialize LCD display
  lcd.init();
  lcd.backlight();

  // Startup splash screen
  lcd.setCursor(2, 0);
  lcd.print("AUTO WATERING");
  lcd.setCursor(4, 1);
  lcd.print("SYSTEM");
  delay(2000);
  lcd.clear();
}

void loop() {
  // 1. Read sensor value
  int raw = analogRead(PIN_SOIL);

  // 2. Convert raw value to percentage (0% - 100%)
  int percent = map(raw, VAL_AIR, VAL_WATER, 0, 100);
  percent = constrain(percent, 0, 100); // Prevent going out of range

  // 3. Control logic (hysteresis)
  if (percent < START_LEVEL) {
    isPumping = true; // Too dry, start watering
  } 
  else if (percent > STOP_LEVEL) {
    isPumping = false; // Moisture is sufficient, stop
  }

  // 4. Pump control
  if (isPumping) {
    digitalWrite(PIN_PUMP, HIGH); // Turn pump ON through MOSFET
  } else {
    digitalWrite(PIN_PUMP, LOW);  // Turn pump OFF
  }

  // 5. Display information on the screen
  
  // Line 1: Current status
  lcd.setCursor(0, 0);
  if (isPumping) {
    lcd.print("[!] PUMP ON...  "); 
  } else {
    // If pump is off, show soil condition
    if (percent > 80) {
      lcd.print("Very Wet (OK)   ");
    } else if (percent > 40) {
      lcd.print("Soil is Good    ");
    } else {
      lcd.print("Getting Dry...  ");
    }
  }

  // Line 2: Moisture percentage and label
  lcd.setCursor(0, 1);
  lcd.print("Level: ");
  lcd.print(percent);
  lcd.print("% ");
  
  // Simple text indication based on moisture levels
  if(percent < 30) lcd.print("LOW ");
  else if(percent < 70) lcd.print("MID ");
  else lcd.print("HIGH");

  delay(1000); // Update every second
}

// Telegram integration code

#include <ESP8266WiFi.h>
#include <ESP8266WebServer.h>
#include <WiFiClientSecure.h>
#include <UniversalTelegramBot.h>

const char* ssid = "YOUR_WIFI_SSID";
const char* password = "YOUR_WIFI_PASSWORD";

WiFiClientSecure secured_client;
UniversalTelegramBot bot("YOUR_TELEGRAM_BOT_TOKEN", secured_client);
String chatID = "YOUR_CHAT_ID";

ESP8266WebServer server(80);

// Pins
const int MOISTURE_PIN = A0;
const int PUMP_PIN = D1;

int THRESHOLD = 600;
bool pumpState = false;
bool autoMode = true;

unsigned long lastBotCheck = 0;
unsigned long lastMoistureCheck = 0;

// Function to send a message to Telegram
void sendMessage(String text) {
  bot.sendMessage(chatID, text, "");
}

// Simple HTML dashboard
String htmlPage() {
  int moisture = analogRead(MOISTURE_PIN);
  String s = "<html><body>";
  s += "<h2>Irrigation Dashboard</h2>";
  s += "<p>Moisture: " + String(moisture) + "</p>";
  s += "<p>Pump: " + String(pumpState ? "ON" : "OFF") + "</p>";
  s += "<a href='/pump/on'>Pump ON</a><br>";
  s += "<a href='/pump/off'>Pump OFF</a><br>";
  s += "<a href='/auto'>Auto Mode</a> | ";
  s += "<a href='/manual'>Manual Mode</a>";
  s += "</body></html>";
  return s;
}

void handleRoot() { server.send(200, "text/html", htmlPage()); }

void handlePumpOn() {
  digitalWrite(PUMP_PIN, HIGH);
  pumpState = true;
  sendMessage("ðŸš° Pump was turned ON");
  server.sendHeader("Location", "/");
  server.send(302, "text/plain", "");
}

void handlePumpOff() {
  digitalWrite(PUMP_PIN, LOW);
  pumpState = false;
  sendMessage("ðŸ”´ Pump was turned OFF");
  server.sendHeader("Location", "/");
  server.send(302, "text/plain", "");
}

void handleAuto() {
  autoMode = true;
  sendMessage("ðŸŒ¿ Auto mode activated");
  server.sendHeader("Location", "/");
  server.send(302, "text/plain", "");
}

void handleManual() {
  autoMode = false;
  sendMessage("ðŸ›  Manual mode activated");
  server.sendHeader("Location", "/");
  server.send(302, "text/plain", "");
}

void setup() {
  Serial.begin(115200);
  pinMode(PUMP_PIN, OUTPUT);
  digitalWrite(PUMP_PIN, LOW);

  // Wi-Fi
  secured_client.setInsecure(); 
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) { delay(500); }

  sendMessage("ðŸŒ± Irrigation System Online\nIP: " + WiFi.localIP().toString());

  // Server endpoints
  server.on("/", handleRoot);
  server.on("/pump/on", handlePumpOn);
  server.on("/pump/off", handlePumpOff);
  server.on("/auto", handleAuto);
  server.on("/manual", handleManual);

  server.begin();
}

void loop() {
  server.handleClient();

  // Periodic check of moisture
  if (millis() - lastMoistureCheck > 5000) {
    lastMoistureCheck = millis();

    int moisture = analogRead(MOISTURE_PIN);
    Serial.println(moisture);

    // Auto Mode logic with Telegram
    if (autoMode) {
      if (moisture > THRESHOLD && !pumpState) {
        digitalWrite(PUMP_PIN, HIGH);
        pumpState = true;
        sendMessage("âš  Soil is dry (" + String(moisture) + "). Pump ON.");
      } 
      else if (moisture <= THRESHOLD && pumpState) {
        digitalWrite(PUMP_PIN, LOW);
        pumpState = false;
        sendMessage("âœ” Soil moisture restored. Pump OFF.");
      }
    }
  }
}
